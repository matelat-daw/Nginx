<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Flexible - Pruebas</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .profile-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .profile-btn {
            padding: 10px 20px;
            border: 2px solid #3b82f6;
            background: white;
            color: #3b82f6;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .profile-btn.active {
            background: #3b82f6;
            color: white;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #059669;
        }
        .response {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        .info {
            border-color: #17a2b8;
            background-color: #d1ecf1;
        }
        .current-config {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .field-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .field-tag {
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        .required {
            background: #dc3545;
        }
        .optional {
            background: #28a745;
        }
        h1, h2 {
            color: #333;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        .tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <h1>🔧 API Flexible - Panel de Pruebas</h1>
    
    <div class="current-config" id="currentConfig">
        <h3>⚙️ Configuración Actual: <span id="currentProfile">Cargando...</span></h3>
        <div>
            <strong>Campos Requeridos:</strong>
            <div class="field-list" id="requiredFields"></div>
        </div>
        <div>
            <strong>Campos Opcionales:</strong>
            <div class="field-list" id="optionalFields"></div>
        </div>
    </div>

    <div class="container">
        <h2>📝 Seleccionar Perfil de Configuración</h2>
        <div class="profile-selector">
            <button class="profile-btn" onclick="setProfile('minimal')">Mínimo</button>
            <button class="profile-btn" onclick="setProfile('standard')">Estándar</button>
            <button class="profile-btn" onclick="setProfile('complete')">Completo</button>
            <button class="profile-btn" onclick="showCustomConfig()">Personalizado</button>
        </div>
        
        <div id="customConfigForm" style="display: none;">
            <h3>Configuración Personalizada</h3>
            <div class="form-group">
                <label>Campos Requeridos (separados por comas):</label>
                <input type="text" id="customRequired" value="email,password" />
            </div>
            <div class="form-group">
                <label>Campos Opcionales (separados por comas):</label>
                <input type="text" id="customOptional" value="firstName,lastName" />
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="customEmailVerification" /> 
                    Verificación de Email
                </label>
            </div>
            <button onclick="setCustomProfile()">Aplicar Configuración Personalizada</button>
        </div>
        
        <div class="response" id="configResponse"></div>
    </div>

    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="showTab('register')">Registro</div>
            <div class="tab" onclick="showTab('login')">Login</div>
            <div class="tab" onclick="showTab('profile')">Perfil</div>
        </div>

        <!-- Tab Registro -->
        <div class="tab-content active" id="registerTab">
            <h2>📋 Registro de Usuario</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="regEmail" required />
                </div>
                <div class="form-group">
                    <label>Contraseña *</label>
                    <input type="password" id="regPassword" required />
                </div>
                <div class="form-group" id="regFirstNameGroup">
                    <label>Nombre</label>
                    <input type="text" id="regFirstName" />
                </div>
                <div class="form-group" id="regLastNameGroup">
                    <label>Apellido</label>
                    <input type="text" id="regLastName" />
                </div>
                <div class="form-group" id="regPhoneGroup">
                    <label>Teléfono</label>
                    <input type="tel" id="regPhone" />
                </div>
                <div class="form-group" id="regIslandGroup">
                    <label>Isla</label>
                    <select id="regIsland">
                        <option value="">Seleccionar...</option>
                        <option value="Gran Canaria">Gran Canaria</option>
                        <option value="Tenerife">Tenerife</option>
                        <option value="Lanzarote">Lanzarote</option>
                        <option value="Fuerteventura">Fuerteventura</option>
                        <option value="La Palma">La Palma</option>
                        <option value="La Gomera">La Gomera</option>
                        <option value="El Hierro">El Hierro</option>
                    </select>
                </div>
                <div class="form-group" id="regCityGroup">
                    <label>Ciudad</label>
                    <input type="text" id="regCity" />
                </div>
                <div class="form-group" id="regUserTypeGroup">
                    <label>Tipo de Usuario</label>
                    <select id="regUserType">
                        <option value="individual">Individual</option>
                        <option value="business">Empresa</option>
                    </select>
                </div>
                <div class="form-group" id="regAboutGroup">
                    <label>Sobre ti</label>
                    <textarea id="regAbout" rows="3"></textarea>
                </div>
                <button type="submit">Registrar Usuario</button>
                <button type="button" onclick="fillTestData()">Llenar Datos de Prueba</button>
            </form>
            <div class="response" id="registerResponse"></div>
        </div>

        <!-- Tab Login -->
        <div class="tab-content" id="loginTab">
            <h2>🔐 Login de Usuario</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" required />
                </div>
                <div class="form-group">
                    <label>Contraseña</label>
                    <input type="password" id="loginPassword" required />
                </div>
                <button type="submit">Iniciar Sesión</button>
                <button type="button" onclick="fillLoginData()">Usar Último Usuario Registrado</button>
            </form>
            <div class="response" id="loginResponse"></div>
        </div>

        <!-- Tab Perfil -->
        <div class="tab-content" id="profileTab">
            <h2>👤 Perfil de Usuario</h2>
            <button onclick="getProfile()">Obtener Perfil</button>
            <button onclick="logout()">Cerrar Sesión</button>
            <div class="response" id="profileResponse"></div>
            
            <div id="updateProfileSection" style="display: none;">
                <h3>Actualizar Perfil</h3>
                <form id="updateProfileForm">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" id="updateFirstName" />
                    </div>
                    <div class="form-group">
                        <label>Apellido</label>
                        <input type="text" id="updateLastName" />
                    </div>
                    <div class="form-group">
                        <label>Teléfono</label>
                        <input type="tel" id="updatePhone" />
                    </div>
                    <button type="submit">Actualizar Perfil</button>
                </form>
                <div class="response" id="updateResponse"></div>
            </div>
        </div>
    </div>

    <script>
        let currentToken = localStorage.getItem('authToken');
        let lastRegisteredEmail = '';
        let lastRegisteredPassword = '';

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentConfig();
            updateFormFields();
            
            // Event listeners
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('updateProfileForm').addEventListener('submit', handleUpdateProfile);
        });

        // Gestión de tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Cargar configuración actual
        async function loadCurrentConfig() {
            try {
                const response = await fetch('/api/config/');
                const data = await response.json();
                
                if (data.success) {
                    const config = data.data.current.config;
                    document.getElementById('currentProfile').textContent = 
                        config.name + ' (' + data.data.current.profile + ')';
                    
                    updateFieldDisplay(config.required_fields || [], config.optional_fields || []);
                    updateActiveProfileButton(data.data.current.profile);
                    updateFormFields();
                }
            } catch (error) {
                console.error('Error cargando configuración:', error);
            }
        }

        // Actualizar display de campos
        function updateFieldDisplay(required, optional) {
            const requiredContainer = document.getElementById('requiredFields');
            const optionalContainer = document.getElementById('optionalFields');
            
            requiredContainer.innerHTML = required.map(field => 
                `<span class="field-tag required">${field}</span>`
            ).join('');
            
            optionalContainer.innerHTML = optional.map(field => 
                `<span class="field-tag optional">${field}</span>`
            ).join('');
        }

        // Actualizar botón de perfil activo
        function updateActiveProfileButton(profile) {
            document.querySelectorAll('.profile-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`[onclick="setProfile('${profile}')"]`);
            if (activeBtn) activeBtn.classList.add('active');
        }

        // Configurar perfil
        async function setProfile(profileName) {
            try {
                const response = await fetch('/api/config/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ profile: profileName })
                });
                
                const data = await response.json();
                document.getElementById('configResponse').textContent = JSON.stringify(data, null, 2);
                document.getElementById('configResponse').className = 'response ' + (data.success ? 'success' : 'error');
                
                if (data.success) {
                    setTimeout(loadCurrentConfig, 500);
                }
            } catch (error) {
                document.getElementById('configResponse').textContent = 'Error: ' + error.message;
                document.getElementById('configResponse').className = 'response error';
            }
        }

        // Mostrar configuración personalizada
        function showCustomConfig() {
            const form = document.getElementById('customConfigForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        // Configuración personalizada
        async function setCustomProfile() {
            const required = document.getElementById('customRequired').value.split(',').map(s => s.trim()).filter(s => s);
            const optional = document.getElementById('customOptional').value.split(',').map(s => s.trim()).filter(s => s);
            const emailVerification = document.getElementById('customEmailVerification').checked;
            
            const customConfig = {
                name: 'Configuración Personalizada',
                required_fields: required,
                optional_fields: optional,
                email_verification: emailVerification,
                user_validation: 'custom',
                registration_flow: 'custom',
                profile_fields: ['id', 'email', ...required, ...optional]
            };
            
            try {
                const response = await fetch('/api/config/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ custom_config: customConfig })
                });
                
                const data = await response.json();
                document.getElementById('configResponse').textContent = JSON.stringify(data, null, 2);
                document.getElementById('configResponse').className = 'response ' + (data.success ? 'success' : 'error');
                
                if (data.success) {
                    setTimeout(loadCurrentConfig, 500);
                }
            } catch (error) {
                document.getElementById('configResponse').textContent = 'Error: ' + error.message;
                document.getElementById('configResponse').className = 'response error';
            }
        }

        // Actualizar campos del formulario según configuración
        function updateFormFields() {
            // Campos del formulario de registro
            const fields = {
                'firstName': 'regFirstNameGroup',
                'lastName': 'regLastNameGroup', 
                'phoneNumber': 'regPhoneGroup',
                'island': 'regIslandGroup',
                'city': 'regCityGroup',
                'userType': 'regUserTypeGroup',
                'about': 'regAboutGroup'
            };
            
            // Ocultar todos los campos opcionales primero
            Object.values(fields).forEach(groupId => {
                const group = document.getElementById(groupId);
                if (group) group.style.display = 'none';
            });
            
            // Mostrar solo los campos configurados
            fetch('/api/config/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const config = data.data.current.config;
                        const allFields = [...(config.required_fields || []), ...(config.optional_fields || [])];
                        
                        allFields.forEach(field => {
                            if (fields[field]) {
                                const group = document.getElementById(fields[field]);
                                if (group) {
                                    group.style.display = 'block';
                                    const label = group.querySelector('label');
                                    const isRequired = (config.required_fields || []).includes(field);
                                    if (label && !label.textContent.includes('*') && isRequired) {
                                        label.textContent += ' *';
                                    }
                                }
                            }
                        });
                    }
                })
                .catch(console.error);
        }

        // Llenar datos de prueba
        function fillTestData() {
            const timestamp = Date.now();
            document.getElementById('regEmail').value = `usuario${timestamp}@prueba.com`;
            document.getElementById('regPassword').value = 'password123';
            document.getElementById('regFirstName').value = 'Usuario';
            document.getElementById('regLastName').value = 'Prueba';
            document.getElementById('regPhone').value = '+34123456789';
            document.getElementById('regIsland').value = 'Gran Canaria';
            document.getElementById('regCity').value = 'Las Palmas';
            document.getElementById('regUserType').value = 'individual';
            document.getElementById('regAbout').value = 'Usuario de prueba para testing de la API flexible.';
        }

        // Manejar registro
        async function handleRegister(event) {
            event.preventDefault();
            
            const formData = {
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                firstName: document.getElementById('regFirstName').value,
                lastName: document.getElementById('regLastName').value,
                phoneNumber: document.getElementById('regPhone').value,
                island: document.getElementById('regIsland').value,
                city: document.getElementById('regCity').value,
                userType: document.getElementById('regUserType').value,
                about: document.getElementById('regAbout').value,
                include_config_info: true
            };
            
            // Remover campos vacíos
            Object.keys(formData).forEach(key => {
                if (!formData[key] && key !== 'include_config_info') {
                    delete formData[key];
                }
            });
            
            try {
                const response = await fetch('/api/auth/flexible-register.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                document.getElementById('registerResponse').textContent = JSON.stringify(data, null, 2);
                document.getElementById('registerResponse').className = 'response ' + (data.success ? 'success' : 'error');
                
                if (data.success && data.data.token) {
                    currentToken = data.data.token;
                    localStorage.setItem('authToken', currentToken);
                    lastRegisteredEmail = formData.email;
                    lastRegisteredPassword = formData.password;
                }
            } catch (error) {
                document.getElementById('registerResponse').textContent = 'Error: ' + error.message;
                document.getElementById('registerResponse').className = 'response error';
            }
        }

        // Llenar datos de login
        function fillLoginData() {
            if (lastRegisteredEmail) {
                document.getElementById('loginEmail').value = lastRegisteredEmail;
                document.getElementById('loginPassword').value = lastRegisteredPassword;
            }
        }

        // Manejar login
        async function handleLogin(event) {
            event.preventDefault();
            
            const loginData = {
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value,
                include_config_info: true
            };
            
            try {
                const response = await fetch('/api/auth/flexible-login.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(loginData)
                });
                
                const data = await response.json();
                document.getElementById('loginResponse').textContent = JSON.stringify(data, null, 2);
                document.getElementById('loginResponse').className = 'response ' + (data.success ? 'success' : 'error');
                
                if (data.success && data.data.token) {
                    currentToken = data.data.token;
                    localStorage.setItem('authToken', currentToken);
                }
            } catch (error) {
                document.getElementById('loginResponse').textContent = 'Error: ' + error.message;
                document.getElementById('loginResponse').className = 'response error';
            }
        }

        // Obtener perfil
        async function getProfile() {
            if (!currentToken) {
                document.getElementById('profileResponse').textContent = 'No hay token de autenticación';
                document.getElementById('profileResponse').className = 'response error';
                return;
            }
            
            try {
                const response = await fetch('/api/auth/flexible-profile.php', {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });
                
                const data = await response.json();
                document.getElementById('profileResponse').textContent = JSON.stringify(data, null, 2);
                document.getElementById('profileResponse').className = 'response ' + (data.success ? 'success' : 'error');
                
                if (data.success) {
                    document.getElementById('updateProfileSection').style.display = 'block';
                    // Llenar formulario de actualización
                    const user = data.data.user;
                    document.getElementById('updateFirstName').value = user.firstName || '';
                    document.getElementById('updateLastName').value = user.lastName || '';
                    document.getElementById('updatePhone').value = user.phoneNumber || '';
                }
            } catch (error) {
                document.getElementById('profileResponse').textContent = 'Error: ' + error.message;
                document.getElementById('profileResponse').className = 'response error';
            }
        }

        // Actualizar perfil
        async function handleUpdateProfile(event) {
            event.preventDefault();
            
            if (!currentToken) {
                document.getElementById('updateResponse').textContent = 'No hay token de autenticación';
                document.getElementById('updateResponse').className = 'response error';
                return;
            }
            
            const updateData = {
                firstName: document.getElementById('updateFirstName').value,
                lastName: document.getElementById('updateLastName').value,
                phoneNumber: document.getElementById('updatePhone').value
            };
            
            try {
                const response = await fetch('/api/auth/flexible-profile.php', {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + currentToken 
                    },
                    body: JSON.stringify(updateData)
                });
                
                const data = await response.json();
                document.getElementById('updateResponse').textContent = JSON.stringify(data, null, 2);
                document.getElementById('updateResponse').className = 'response ' + (data.success ? 'success' : 'error');
            } catch (error) {
                document.getElementById('updateResponse').textContent = 'Error: ' + error.message;
                document.getElementById('updateResponse').className = 'response error';
            }
        }

        // Cerrar sesión
        function logout() {
            currentToken = null;
            localStorage.removeItem('authToken');
            document.getElementById('profileResponse').textContent = 'Sesión cerrada';
            document.getElementById('profileResponse').className = 'response info';
            document.getElementById('updateProfileSection').style.display = 'none';
        }
    </script>
</body>
</html>
